<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HL Steel Â· ä¾›åº”å•†æŠ¥ä»·ç³»ç»Ÿ</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: #f0f4f8;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
            padding: 2rem 1rem;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #1e3c4f 0%, #2a4a63 100%);
            color: white;
            padding: 1.8rem 2.5rem;
            border-radius: 32px;
            margin-bottom: 2rem;
            box-shadow: 0 20px 30px -10px rgba(0,40,60,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header .badge {
            background: #ffb347;
            color: #1e2f47;
            padding: 0.4rem 1.5rem;
            border-radius: 40px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .timestamp-card {
            background: rgba(255,255,255,0.15);
            padding: 0.8rem 2rem;
            border-radius: 40px;
            font-size: 1.2rem;
        }

        .supplier-info {
            background: white;
            border-radius: 24px;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 20px rgba(0,20,40,0.08);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .supplier-selector {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .supplier-selector label {
            font-weight: 600;
            color: #2d4a6e;
            font-size: 1.1rem;
        }

        .supplier-selector select {
            padding: 0.8rem 2rem 0.8rem 1.2rem;
            border: 2px solid #dde5ed;
            border-radius: 40px;
            font-size: 1rem;
            font-weight: 500;
            background: white;
            cursor: pointer;
            min-width: 200px;
        }

        .info-note {
            color: #4a6b8a;
            background: #f0f7ff;
            padding: 0.5rem 1.5rem;
            border-radius: 40px;
        }

        .materials-table {
            background: white;
            border-radius: 28px;
            padding: 2rem 1.5rem;
            box-shadow: 0 12px 30px rgba(0,20,40,0.1);
            margin-bottom: 2rem;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        th {
            background: #eef2f6;
            padding: 1rem 0.5rem;
            font-weight: 600;
            color: #1e2f47;
            text-align: center;
        }

        td {
            padding: 0.9rem 0.3rem;
            border-bottom: 1px solid #e0e7ed;
            text-align: center;
            vertical-align: middle;
        }

        .row-number {
            font-weight: 600;
            color: #2a6bff;
            background: #e9effa;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin: 0 auto;
        }

        .supplier-tag {
            background: #e1f0fa;
            color: #0b4b7a;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }

        .price-input {
            width: 110px;
            padding: 0.7rem 0.5rem;
            border: 2px solid #dde5ed;
            border-radius: 12px;
            font-size: 1rem;
            text-align: center;
        }

        .price-input:focus {
            outline: none;
            border-color: #2a6bff;
        }

        .remark-input {
            width: 130px;
            padding: 0.5rem;
            border: 1px solid #e0e7ed;
            border-radius: 8px;
        }

        .action-bar {
            background: white;
            border-radius: 40px;
            padding: 1.5rem 2rem;
            box-shadow: 0 8px 25px rgba(0,20,40,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 2rem;
        }

        .summary-info {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .summary-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #2d4a6e;
        }

        .summary-item .value {
            font-weight: 700;
            font-size: 1.3rem;
            color: #1e3c4f;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 1rem 2.5rem;
            border-radius: 50px;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: #1e3c4f;
            color: white;
        }

        .btn-primary:hover {
            background: #2a4a63;
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #eef2f6;
            color: #1e2f47;
        }

        #statusMsg {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 50px;
            background: #f8fafd;
            text-align: center;
            border-left: 5px solid #2a6bff;
        }

        #hidden_iframe {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: #2a6bff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-state {
            text-align: center;
            padding: 4rem 2rem;
            background: #fff2f0;
            border-radius: 28px;
            color: #c74a4a;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>
                    ğŸ“ ä¾›åº”å•†æŠ¥ä»·å•
                    <span class="badge">è¯¢ä»·ä¸“ç”¨</span>
                </h1>
            </div>
            <div class="timestamp-card" id="timestampDisplay">
                â±ï¸ åŠ è½½ä¸­...
            </div>
        </div>

        <div id="supplierSection" style="display: none;">
            <div class="supplier-info">
                <div class="supplier-selector">
                    <label for="supplierSelect">ğŸ‘¤ æŠ¥ä»·ä¾›åº”å•†ï¼š</label>
                    <select id="supplierSelect">
                        <option value="">-- è¯·é€‰æ‹©æ‚¨çš„å…¬å¸ --</option>
                        <option value="Supplier A">A å…¬å¸</option>
                        <option value="Supplier B">B å…¬å¸</option>
                        <option value="Supplier C">C å…¬å¸</option>
                    </select>
                </div>
                <div class="info-note">
                    âš¡ å¡«å†™æ‚¨çš„æŠ¥ä»·åæäº¤
                </div>
            </div>
        </div>

        <div id="contentContainer">
            <div style="text-align: center; padding: 4rem;" id="loadingState">
                <div class="loading"></div>
                <h3>æ­£åœ¨åŠ è½½è¯¢ä»·å•...</h3>
            </div>
        </div>

        <div id="actionBar" style="display: none;">
            <div class="action-bar">
                <div class="summary-info">
                    <div class="summary-item">
                        <span class="label">ğŸ“¦ ææ–™ç§ç±»ï¼š</span>
                        <span class="value" id="materialCount">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">ğŸ’° å·²æŠ¥ä»·ï¼š</span>
                        <span class="value" id="pendingCount">0</span>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="resetPrices()">ğŸ”„ æ¸…ç©º</button>
                    <button class="btn btn-primary" onclick="submitPrices()">ğŸ“¤ æäº¤æŠ¥ä»·</button>
                </div>
            </div>
            <div id="statusMsg">ğŸ‘† é€‰æ‹©ä¾›åº”å•†å¹¶å¡«å†™å•ä»·åæäº¤</div>
        </div>
    </div>

    <iframe name="hidden_iframe" id="hidden_iframe"></iframe>

    <script>
        // ==================== é…ç½®åŒºï¼šè¯·åœ¨è¿™é‡Œå¡«å†™æ‚¨çš„GAS URL ====================
        
        // ã€é‡è¦ã€‘1. è¯»å–é‡‡è´­GSçš„GAS URLï¼ˆç”¨äºè·å–è¯¢ä»·å•æ•°æ®ï¼‰
        const READ_GAS_URL = 'https://script.google.com/macros/s/AKfycbxuf1GoKR9JPf9njqtAHr_GVTNpQ6b1_hRIsQjkVTDvNgHxoXw_4Rtc4obXCjuZQEPx/exec';
        
        // ã€é‡è¦ã€‘2. å†™å…¥ä¾›åº”å•†GSçš„GAS URLï¼ˆç”¨äºæäº¤æŠ¥ä»·ï¼‰
        const WRITE_GAS_URL = 'https://script.google.com/macros/s/AKfycbzG9oNFM1qVVlx0VUmy7uRJ5IxLJbx1LxRGGTkqdSNsj_fXW_8CXZHJLswDVkIseVlU1w/exec';
        
        // ==================== ä»¥ä¸‹ä»£ç ä¸éœ€è¦ä¿®æ”¹ ====================
        
        // ä»URLè·å–å‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const timestamp = urlParams.get('H');
        
        // å­˜å‚¨ä»é‡‡è´­GSè·å–çš„æ•°æ®
        let materialRows = [];

        document.addEventListener('DOMContentLoaded', function() {
            if (!timestamp) {
                showError('ç¼ºå°‘è¯¢ä»·å•æ ‡è¯† (Hå‚æ•°)');
                return;
            }
            
            document.getElementById('timestampDisplay').textContent = `â±ï¸ è¯¢ä»·å•: ${timestamp}`;
            loadQuotationData();
        });

        // åŠ è½½é‡‡è´­æ•°æ®
        function loadQuotationData() {
            const fetchUrl = `${READ_GAS_URL}?action=getQuotation&timestamp=${encodeURIComponent(timestamp)}`;
            
            fetch(fetchUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        materialRows = data.rows || [];
                        renderTable();
                        document.getElementById('supplierSection').style.display = 'block';
                        document.getElementById('actionBar').style.display = 'block';
                        document.getElementById('loadingState').style.display = 'none';
                    } else {
                        showError('åŠ è½½å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    showError('ç½‘ç»œé”™è¯¯: ' + error.message);
                });
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const container = document.getElementById('contentContainer');
            
            if (!materialRows || materialRows.length === 0) {
                container.innerHTML = '<div class="error-state"><h3>ğŸ“­ æ²¡æœ‰æ‰¾åˆ°ææ–™æ•°æ®</h3></div>';
                return;
            }

            let tableHtml = `
                <div class="materials-table">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Type</th>
                                <th>Thick</th>
                                <th>Size</th>
                                <th>Surface</th>
                                <th>TON</th>
                                <th>PCS</th>
                                <th>é‡‡è´­æŒ‡å®šä¾›åº”å•†</th>
                                <th>æ‚¨çš„æŠ¥ä»· (RM)</th>
                                <th>å¤‡æ³¨</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            materialRows.forEach((row, index) => {
                const rowNum = row.rowNum || index + 1;
                
                tableHtml += `
                    <tr data-row="${rowNum}">
                        <td><div class="row-number">${rowNum}</div></td>
                        <td>${row.type || '-'}</td>
                        <td>${row.thick || '-'}</td>
                        <td>${row.size || '-'}</td>
                        <td>${row.surface || '-'}</td>
                        <td>${row.ton || '-'}</td>
                        <td>${row.pcs || '-'}</td>
                        <td><span class="supplier-tag">${row.suppliers || 'æœªæŒ‡å®š'}</span></td>
                        <td>
                            <input type="number" 
                                   class="price-input" 
                                   data-row="${rowNum}"
                                   data-type="${row.type || ''}"
                                   data-thick="${row.thick || ''}"
                                   data-size="${row.size || ''}"
                                   data-surface="${row.surface || ''}"
                                   data-ton="${row.ton || ''}"
                                   data-pcs="${row.pcs || ''}"
                                   data-suppliers="${row.suppliers || ''}"
                                   placeholder="å•ä»·" 
                                   min="0" 
                                   step="0.01"
                                   oninput="updatePendingCount()">
                        </td>
                        <td>
                            <input type="text" 
                                   class="remark-input" 
                                   data-row="${rowNum}"
                                   placeholder="å¤‡æ³¨">
                        </td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table></div>';
            container.innerHTML = tableHtml;
            
            document.getElementById('materialCount').textContent = materialRows.length;
            updatePendingCount();
        }

        // æ›´æ–°å·²æŠ¥ä»·æ•°é‡
        function updatePendingCount() {
            const priceInputs = document.querySelectorAll('.price-input');
            let filledCount = 0;
            priceInputs.forEach(input => {
                if (input.value && parseFloat(input.value) > 0) {
                    filledCount++;
                }
            });
            document.getElementById('pendingCount').textContent = filledCount;
        }

        // æ¸…ç©ºæ‰€æœ‰ä»·æ ¼
        function resetPrices() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²å¡«å†™çš„å•ä»·å—ï¼Ÿ')) {
                document.querySelectorAll('.price-input').forEach(input => input.value = '');
                document.querySelectorAll('.remark-input').forEach(input => input.value = '');
                updatePendingCount();
                document.getElementById('statusMsg').innerHTML = 'ğŸ§¹ å·²æ¸…ç©ºæ‰€æœ‰æŠ¥ä»·';
            }
        }

        // æäº¤æŠ¥ä»· - ä½¿ç”¨ WRITE_GAS_URL
        function submitPrices() {
            const supplier = document.getElementById('supplierSelect').value;
            if (!supplier) {
                alert('è¯·å…ˆé€‰æ‹©æ‚¨çš„å…¬å¸');
                return;
            }

            // æ”¶é›†æŠ¥ä»·æ•°æ®
            const priceRows = [];
            const rows = document.querySelectorAll('tr[data-row]');
            
            rows.forEach(row => {
                const rowNum = row.getAttribute('data-row');
                const priceInput = row.querySelector('.price-input');
                const remarkInput = row.querySelector('.remark-input');
                
                // ä»dataå±æ€§è·å–ææ–™ä¿¡æ¯
                const type = priceInput?.dataset.type || '';
                const thick = priceInput?.dataset.thick || '';
                const size = priceInput?.dataset.size || '';
                const surface = priceInput?.dataset.surface || '';
                const ton = priceInput?.dataset.ton || '';
                const pcs = priceInput?.dataset.pcs || '';
                const suppliers = priceInput?.dataset.suppliers || '';
                
                priceRows.push({
                    rowNum: rowNum,
                    type: type,
                    thick: thick,
                    size: size,
                    surface: surface,
                    ton: ton,
                    pcs: pcs,
                    suppliers: suppliers,
                    price: priceInput?.value || '',
                    remark: remarkInput?.value || '',
                    quotedBy: supplier
                });
            });

            // æ„å»ºæäº¤æ•°æ®
            const payload = {
                action: 'saveSupplierQuotation',
                timestamp: timestamp,
                supplier: supplier,
                rows: priceRows
            };

            // ç¦ç”¨æäº¤æŒ‰é’®
            const submitBtn = document.querySelector('.btn-primary');
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'â³ æäº¤ä¸­...';

            // åˆ›å»ºè¡¨å•æäº¤åˆ° WRITE_GAS_URL
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = WRITE_GAS_URL;
            form.target = 'hidden_iframe';
            form.style.display = 'none';

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'data';
            input.value = JSON.stringify(payload);
            form.appendChild(input);

            document.body.appendChild(form);
            
            document.getElementById('statusMsg').innerHTML = 'â³ æäº¤ä¸­ï¼Œè¯·ç¨å€™...';
            form.submit();

            // ç›‘å¬iframeåŠ è½½å®Œæˆ
            document.getElementById('hidden_iframe').onload = function() {
                document.getElementById('statusMsg').innerHTML = 'âœ… æŠ¥ä»·å·²æˆåŠŸæäº¤ï¼';
                submitBtn.innerHTML = 'âœ… å·²æäº¤';
            };

            // 5ç§’åæ¸…ç†form
            setTimeout(() => {
                if (document.body.contains(form)) {
                    document.body.removeChild(form);
                }
            }, 5000);
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('contentContainer').innerHTML = `
                <div class="error-state">
                    <h3>âŒ ${message}</h3>
                    <button class="btn btn-secondary" onclick="location.reload()">ğŸ”„ é‡æ–°åŠ è½½</button>
                </div>
            `;
            document.getElementById('timestampDisplay').textContent = 'â±ï¸ åŠ è½½å¤±è´¥';
        }
    </script>
</body>
</html>
